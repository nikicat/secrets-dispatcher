---
phase: 03-ui-and-observability
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/lib/types.ts
  - web/src/lib/RequestCard.svelte
  - web/src/lib/notifications.ts
  - web/src/App.svelte
  - web/src/app.css
autonomous: false
requirements:
  - DISP-02
  - DISP-03
  - DISP-05

must_haves:
  truths:
    - "Web UI displays gpg_sign card with commit subject, author, key ID, changed files, and expandable body"
    - "gpg_sign card has purple/violet left border accent, visually distinct from blue get_secret cards"
    - "Type badge ('GPG Sign', 'Secret', 'Search') appears on ALL card types"
    - "Session identity (PID + repo for gpg_sign, PID for others) appears at top of ALL cards"
    - "History entries show type badge and commit subject for gpg_sign entries"
    - "Browser notifications use 'Commit Signing Request' title for gpg_sign and 'Secret Request' for others"
  artifacts:
    - path: "web/src/lib/types.ts"
      provides: "GPGSignInfo interface and updated PendingRequest type union"
      contains: "gpg_sign"
    - path: "web/src/lib/RequestCard.svelte"
      provides: "gpg_sign card content, type badge, session identity line"
      contains: "gpg_sign"
    - path: "web/src/lib/notifications.ts"
      provides: "gpg_sign notification title and body formatting"
      contains: "Commit Signing Request"
    - path: "web/src/App.svelte"
      provides: "History view type badge and gpg_sign summary"
      contains: "gpg_sign"
    - path: "web/src/app.css"
      provides: "CSS variables for gpg_sign purple/violet accent color"
      contains: "--color-gpg-sign"
  key_links:
    - from: "web/src/lib/RequestCard.svelte"
      to: "web/src/lib/types.ts"
      via: "PendingRequest.gpg_sign_info field access"
      pattern: "request\\.gpg_sign_info"
    - from: "web/src/lib/notifications.ts"
      to: "web/src/lib/types.ts"
      via: "PendingRequest.type === 'gpg_sign' check"
      pattern: "gpg_sign"
    - from: "web/src/App.svelte"
      to: "web/src/lib/types.ts"
      via: "HistoryEntry.request.type check for type badge"
      pattern: "request\\.type"
---

<objective>
Add gpg_sign display support to the Svelte 5 web UI: card content, visual distinction, type badge, session identity, history view, and browser notifications.

Purpose: Users see gpg_sign signing requests in a visually distinct purple-accented card with commit subject, author, key ID, and changed files. Type badges and session identity lines appear on ALL card types for consistent scanning. Browser notifications show appropriate titles per request type.

Output: Updated types.ts, RequestCard.svelte, App.svelte, notifications.ts, and app.css.
</objective>

<execution_context>
@/home/nb/.claude-personal/get-shit-done/workflows/execute-plan.md
@/home/nb/.claude-personal/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@web/src/lib/types.ts
@web/src/lib/RequestCard.svelte
@web/src/lib/notifications.ts
@web/src/App.svelte
@web/src/app.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TypeScript types and CSS variables</name>
  <files>web/src/lib/types.ts, web/src/app.css</files>
  <action>
  1. **Add GPGSignInfo interface** to `types.ts`:
     ```ts
     export interface GPGSignInfo {
       repo_name: string;
       commit_msg: string;
       author: string;
       committer: string;
       key_id: string;
       fingerprint?: string;
       changed_files: string[];
       parent_hash?: string;
     }
     ```

  2. **Update PendingRequest interface** in `types.ts`:
     - Change `type` to `"get_secret" | "search" | "gpg_sign"`
     - Add `gpg_sign_info?: GPGSignInfo;` field

  3. **Add CSS variables** to `app.css` `:root` block:
     ```css
     --color-gpg-sign: #8b5cf6;
     --color-gpg-sign-bg: rgba(139, 92, 246, 0.08);
     --color-gpg-sign-border: #7c3aed;
     ```
     Place after existing `--color-warning` line.
  </action>
  <verify>
    <automated>cd /home/nb/src/secrets-dispatcher/web && deno task check 2>&1 || echo "check task may not exist; build will verify"</automated>
  </verify>
  <done>GPGSignInfo interface exists. PendingRequest type union includes "gpg_sign". CSS variables for purple accent defined.</done>
</task>

<task type="auto">
  <name>Task 2: Add gpg_sign card content, type badge, and session identity to RequestCard</name>
  <files>web/src/lib/RequestCard.svelte</files>
  <action>
  All new code MUST use Svelte 5 runes API (`$state`, `$props`, `$effect`), following the existing patterns in RequestCard.svelte.

  1. **Add helper functions** in the `<script>` section:
     ```ts
     function commitSubject(msg: string): string {
       return msg.split('\n')[0];
     }

     function commitBody(msg: string): string {
       const lines = msg.split('\n');
       if (lines.length <= 1) return '';
       const body = lines.slice(1).join('\n').replace(/^\n/, '');
       return body.trimEnd();
     }

     function typeBadgeLabel(type: string): string {
       switch (type) {
         case "gpg_sign": return "GPG Sign";
         case "search": return "Search";
         default: return "Secret";
       }
     }
     ```

  2. **Add type badge and session identity to card header** — modify the `.card-header` section. Inside `.card-title`, BEFORE the existing `item-summary` span, add:
     ```svelte
     <div class="card-identity">
       <span class="type-badge type-badge--{request.type}">
         {typeBadgeLabel(request.type)}
       </span>
       <span class="session-id">
         {#if request.type === "gpg_sign" && request.gpg_sign_info}
           PID {request.sender_info.pid} · {request.gpg_sign_info.repo_name}
         {:else if request.sender_info?.pid}
           PID {request.sender_info.pid}
         {/if}
       </span>
     </div>
     ```
     The session identity and type badge apply to ALL card types per locked decision.

  3. **Update `.item-summary` for gpg_sign** — the current content shows `request.items.map(...)`. Wrap it so gpg_sign shows the commit subject instead:
     ```svelte
     <span class="item-summary">
       {#if request.type === "gpg_sign" && request.gpg_sign_info}
         {commitSubject(request.gpg_sign_info.commit_msg)}
       {:else}
         {request.items.map(i => i.label || i.path).join(", ") || "Secret request"}
       {/if}
     </span>
     ```

  4. **Add card type class** — change `<div class="card">` to `<div class="card card--{request.type}">` so CSS can target per-type styling.

  5. **Add gpg_sign content section** — before the existing `{:else}` block (the get_secret branch), add a `{:else if request.type === "gpg_sign" && request.gpg_sign_info}` branch:
     ```svelte
     {:else if request.type === "gpg_sign" && request.gpg_sign_info}
       {@const info = request.gpg_sign_info}
       <div class="gpg-sign-content">
         <div class="commit-meta">
           <div class="meta-row">
             <span class="meta-label">Author</span>
             <span class="meta-value">{info.author}</span>
           </div>
           <div class="meta-row">
             <span class="meta-label">Key</span>
             <span class="meta-value mono">{info.key_id}</span>
           </div>
         </div>

         {#if commitBody(info.commit_msg)}
           <details class="commit-body-toggle">
             <summary>Show full message</summary>
             <pre class="commit-body">{commitBody(info.commit_msg)}</pre>
           </details>
         {/if}

         <div class="changed-files">
           <span class="section-label">Changed files ({info.changed_files.length})</span>
           {#each info.changed_files.slice(0, 5) as file}
             <div class="file-path mono">{file}</div>
           {/each}
           {#if info.changed_files.length > 5}
             <details>
               <summary>{info.changed_files.length - 5} more files</summary>
               {#each info.changed_files.slice(5) as file}
                 <div class="file-path mono">{file}</div>
               {/each}
             </details>
           {/if}
         </div>

         <details class="secondary-meta">
           <summary>More details</summary>
           {#if info.committer && info.committer !== info.author}
             <div>Committer: {info.committer}</div>
           {/if}
           {#if info.parent_hash}
             <div class="mono">Parent: {info.parent_hash}</div>
           {/if}
         </details>
       </div>
     ```

  6. **Add CSS styles** in the `<style>` section. Add card type accent:
     ```css
     .card.card--gpg_sign {
       border-left: 3px solid var(--color-gpg-sign-border);
     }
     ```

     Add type badge styles:
     ```css
     .card-identity {
       display: flex;
       align-items: center;
       gap: 8px;
       margin-bottom: 2px;
     }

     .type-badge {
       font-size: 11px;
       font-weight: 600;
       text-transform: uppercase;
       padding: 1px 6px;
       border-radius: var(--radius-sm);
       color: var(--color-text-muted);
       background-color: var(--color-bg);
       border: 1px solid var(--color-border);
     }

     .type-badge--gpg_sign {
       color: var(--color-gpg-sign);
       background-color: var(--color-gpg-sign-bg);
       border-color: var(--color-gpg-sign);
     }

     .session-id {
       font-size: 11px;
       color: var(--color-text-muted);
       font-family: ui-monospace, "SF Mono", Monaco, monospace;
     }
     ```

     Add gpg_sign content styles:
     ```css
     .gpg-sign-content {
       margin-bottom: 16px;
     }

     .commit-meta {
       margin-bottom: 12px;
     }

     .meta-row {
       display: flex;
       gap: 8px;
       font-size: 13px;
       padding: 2px 0;
     }

     .meta-label {
       color: var(--color-text-muted);
       min-width: 50px;
     }

     .meta-value {
       color: var(--color-text);
     }

     .mono {
       font-family: ui-monospace, "SF Mono", Monaco, monospace;
       font-size: 12px;
     }

     .commit-body-toggle {
       margin-bottom: 12px;
     }

     .commit-body-toggle summary {
       font-size: 12px;
       color: var(--color-primary);
       cursor: pointer;
     }

     .commit-body {
       margin-top: 8px;
       padding: 8px 12px;
       background-color: var(--color-bg);
       border: 1px solid var(--color-border);
       border-radius: var(--radius-sm);
       font-size: 12px;
       font-family: ui-monospace, "SF Mono", Monaco, monospace;
       white-space: pre-wrap;
       color: var(--color-text-muted);
     }

     .changed-files {
       margin-bottom: 12px;
     }

     .section-label {
       display: block;
       font-size: 13px;
       font-weight: 600;
       color: var(--color-text-muted);
       margin-bottom: 4px;
     }

     .file-path {
       font-size: 12px;
       color: var(--color-text);
       padding: 2px 0;
     }

     .changed-files details summary {
       font-size: 12px;
       color: var(--color-primary);
       cursor: pointer;
       padding-top: 4px;
     }

     .secondary-meta {
       font-size: 12px;
       color: var(--color-text-muted);
     }

     .secondary-meta summary {
       color: var(--color-primary);
       cursor: pointer;
     }

     .secondary-meta div {
       padding: 2px 0;
     }
     ```
  </action>
  <verify>
    <automated>cd /home/nb/src/secrets-dispatcher/web && deno task build</automated>
    <manual>Inspect built output for compilation errors.</manual>
  </verify>
  <done>
  - gpg_sign card renders with purple left border, commit subject as headline, author, key ID, expandable body, changed files (first 5 + expand), secondary metadata
  - Type badge appears on ALL cards (GPG Sign / Secret / Search)
  - Session identity (PID + repo for gpg_sign, PID for others) at top of ALL cards
  - Svelte build succeeds without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Update App.svelte history view and browser notifications</name>
  <files>web/src/App.svelte, web/src/lib/notifications.ts</files>
  <action>
  1. **Update browser notifications** in `notifications.ts`:
     - Change `showRequestNotification` title from hard-coded `"Secret Access Request"` to a conditional:
       ```ts
       const title = request.type === "gpg_sign"
         ? "Commit Signing Request"
         : "Secret Request";
       ```
       Note: "Secret Access Request" → "Secret Request" per locked decision.
     - Add gpg_sign branch to `formatBody`:
       ```ts
       if (request.type === "gpg_sign" && request.gpg_sign_info) {
         parts.push(`Repo: ${request.gpg_sign_info.repo_name}`);
         parts.push(request.gpg_sign_info.commit_msg.split('\n')[0]);
         return parts.join("\n");
       }
       ```
       Insert this BEFORE the existing `get_secret` branch. Keep existing get_secret/search branches unchanged.

  2. **Update history entry type badge** in `App.svelte` — the current `.history-type` span shows:
     ```svelte
     <span class="history-type">{entry.request.type === "search" ? "search" : "get"}</span>
     ```
     Change to handle all three types with consistent labeling:
     ```svelte
     <span class="history-type history-type--{entry.request.type}">
       {#if entry.request.type === "gpg_sign"}
         GPG Sign
       {:else if entry.request.type === "search"}
         Search
       {:else}
         Secret
       {/if}
     </span>
     ```
     Apply this to BOTH history section blocks (the one after empty state AND the one after pending requests — they are duplicated in App.svelte).

  3. **Update history items summary** — the current `.history-items` shows:
     ```svelte
     <span class="history-items">{entry.request.items.map(i => i.label || i.path).join(", ")}</span>
     ```
     Add a helper function in the `<script>` section:
     ```ts
     function historyItemsSummary(request: PendingRequest): string {
       if (request.type === "gpg_sign" && request.gpg_sign_info) {
         return request.gpg_sign_info.commit_msg.split('\n')[0];
       }
       return request.items.map(i => i.label || i.path).join(", ");
     }
     ```
     Replace both history items spans with `{historyItemsSummary(entry.request)}`.

  4. **Add history type badge styling for gpg_sign** in the `<style>` section:
     ```css
     .history-type--gpg_sign {
       color: var(--color-gpg-sign);
       border-color: var(--color-gpg-sign);
       background-color: var(--color-gpg-sign-bg);
     }
     ```

  5. **Add session identity to history entries** — in the `.history-sender` span, update the `formatSenderInfo` helper to include repo name for gpg_sign:
     ```ts
     function formatSenderInfo(entry: HistoryEntry): string {
       const info = entry.request.sender_info;
       if (!info) return entry.request.client;

       // Prefix with repo for gpg_sign
       const repoPrefix = entry.request.type === "gpg_sign" && entry.request.gpg_sign_info
         ? entry.request.gpg_sign_info.repo_name + " · "
         : "";

       const user = info.user_name || (info.uid ? `UID ${info.uid}` : "");

       if (info.unit_name) {
         return repoPrefix + (user ? `${info.unit_name} (${user})` : info.unit_name);
       }
       if (info.pid && user) {
         return repoPrefix + `${user} (PID ${info.pid})`;
       }
       if (info.pid) {
         return repoPrefix + `PID ${info.pid}`;
       }
       return repoPrefix + entry.request.client;
     }
     ```

  6. **Import GPGSignInfo type** if needed (it is already part of PendingRequest, so no additional import needed).
  </action>
  <verify>
    <automated>cd /home/nb/src/secrets-dispatcher/web && deno task build</automated>
    <manual>Build succeeds. Notification title conditional added. History type badge handles three types.</manual>
  </verify>
  <done>
  - Browser notifications use "Commit Signing Request" for gpg_sign, "Secret Request" for others
  - gpg_sign browser notification body shows repo and commit subject
  - History entries show "GPG Sign" / "Secret" / "Search" type badges with appropriate styling
  - History items show commit subject for gpg_sign entries
  - History sender includes repo name for gpg_sign entries
  </done>
</task>

</tasks>

<verification>
```bash
cd /home/nb/src/secrets-dispatcher/web && deno task build
```
Build succeeds. All Svelte components compile. No TypeScript errors.

Post-implementation visual check: The web UI should be verified with a real gpg_sign request to confirm layout and styling.
</verification>

<success_criteria>
- `deno task build` succeeds in web/ directory
- GPGSignInfo TypeScript interface matches Go struct JSON tags
- PendingRequest type union includes "gpg_sign"
- gpg_sign card has purple left border accent
- Type badge on ALL cards (GPG Sign, Secret, Search)
- Session identity line on ALL cards (PID + repo for gpg_sign)
- History entries show gpg_sign type badge and commit subject
- Browser notifications dispatch with correct titles per request type
</success_criteria>

<output>
After completion, create `.planning/phases/03-ui-and-observability/03-03-SUMMARY.md`
</output>
