---
phase: 03-ui-and-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/notification/desktop.go
  - internal/notification/desktop_test.go
autonomous: true
requirements:
  - DISP-01

must_haves:
  truths:
    - "Desktop notification fires with title 'Commit Signing Request' when a gpg_sign request is created"
    - "Desktop notification fires with title 'Secret Request' (not 'Secret Access Request') when a get_secret request is created"
    - "gpg_sign notification body contains repo name and commit subject line"
    - "gpg_sign notification uses a different icon than get_secret notification"
  artifacts:
    - path: "internal/notification/desktop.go"
      provides: "gpg_sign notification branch, per-type icon, renamed get_secret title"
      contains: "Commit Signing Request"
    - path: "internal/notification/desktop_test.go"
      provides: "Tests for gpg_sign notification title, body, icon, and renamed get_secret title"
      contains: "TestHandler_OnEvent_GPGSignRequest"
  key_links:
    - from: "internal/notification/desktop.go"
      to: "internal/approval/gpgsign.go"
      via: "req.Type == RequestTypeGPGSign and req.GPGSignInfo fields"
      pattern: "approval\\.RequestTypeGPGSign"
---

<objective>
Add gpg_sign support to desktop notifications and rename get_secret notification title.

Purpose: When a gpg_sign signing request arrives, the user gets a desktop notification with "Commit Signing Request" title, repo name, and commit subject. The notification uses a distinct icon. Also renames existing get_secret title from "Secret Access Request" to "Secret Request" per user decision.

Output: Updated desktop.go with gpg_sign notification branch, per-type icon support, and updated desktop_test.go with tests for both gpg_sign and the renamed title.
</objective>

<execution_context>
@/home/nb/.claude-personal/get-shit-done/workflows/execute-plan.md
@/home/nb/.claude-personal/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/notification/desktop.go
@internal/notification/desktop_test.go
@internal/approval/gpgsign.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add per-type icon to Notifier interface and gpg_sign notification branch</name>
  <files>internal/notification/desktop.go, internal/notification/desktop_test.go</files>
  <action>
  1. **Update Notifier interface** — change `Notify(summary, body string)` to `Notify(summary, body, icon string)` (add icon as third positional param).

  2. **Update DBusNotifier.Notify** — replace hard-coded `"dialog-password"` with the `icon` parameter in the D-Bus call.

  3. **Add `notificationMeta` method on Handler** — returns `(summary, icon string)` based on `req.Type`:
     - `approval.RequestTypeGPGSign` → `"Commit Signing Request"`, `"emblem-important"`
     - default → `"Secret Request"`, `"dialog-password"`
     Note: the get_secret title changes from "Secret Access Request" to "Secret Request" per locked decision.

  4. **Update `handleCreated`** — replace hard-coded `summary := "Secret Access Request"` with a call to `notificationMeta(req)` to get both summary and icon. Pass icon to `h.notifier.Notify(summary, body, icon)`.

  5. **Add `gpg_sign` case to `formatBody`** — when `req.Type == approval.RequestTypeGPGSign && req.GPGSignInfo != nil`:
     - Write `Repo: {info.RepoName}` line
     - Write commit subject (first line of `info.CommitMsg`) as second line
     - Add a local `commitSubject(msg string) string` helper that returns `msg[:strings.IndexByte(msg, '\n')]` or the full msg if no newline.

  6. **Update mockNotifier in desktop_test.go** — add `icon string` field to `notifyCall` struct. Update `mockNotifier.Notify` to accept and record the icon parameter.

  7. **Update existing test assertion** in `TestHandler_OnEvent_RequestCreated` — change expected summary from `"Secret Access Request"` to `"Secret Request"`.

  8. **Add new test `TestHandler_OnEvent_GPGSignRequest`** — create a `*approval.Request` with `Type: approval.RequestTypeGPGSign` and populated `GPGSignInfo` (repo "my-project", commit msg "Add feature\n\nSome body text", key ID "ABCD1234", author "John", changed files ["a.go", "b.go"]). Fire `EventRequestCreated`. Assert:
     - summary == "Commit Signing Request"
     - icon == "emblem-important"
     - body contains "my-project"
     - body contains "Add feature" (subject line only, not "Some body text")

  9. **Add test `TestHandler_OnEvent_GetSecretIcon`** — assert that get_secret requests get icon == "dialog-password" and summary == "Secret Request".
  </action>
  <verify>
    <automated>cd /home/nb/src/secrets-dispatcher && go test -race -v ./internal/notification/...</automated>
    <manual>Check that all tests pass including new gpg_sign notification test and renamed title test.</manual>
  </verify>
  <done>
  - gpg_sign requests produce notification with title "Commit Signing Request", icon "emblem-important", body containing repo name and commit subject
  - get_secret requests produce notification with title "Secret Request" (renamed from "Secret Access Request"), icon "dialog-password"
  - All existing tests pass with updated assertions
  - New tests verify gpg_sign notification content and icon dispatch
  </done>
</task>

</tasks>

<verification>
```bash
cd /home/nb/src/secrets-dispatcher && go test -race -v ./internal/notification/...
```
All tests pass. New gpg_sign notification test confirms title, icon, and body content. Existing tests updated for "Secret Request" title.
</verification>

<success_criteria>
- `go test -race ./internal/notification/...` passes
- gpg_sign notification dispatches with "Commit Signing Request" title and "emblem-important" icon
- get_secret notification dispatches with "Secret Request" title (renamed) and "dialog-password" icon
- gpg_sign notification body contains repo name and commit subject line only
</success_criteria>

<output>
After completion, create `.planning/phases/03-ui-and-observability/03-01-SUMMARY.md`
</output>
