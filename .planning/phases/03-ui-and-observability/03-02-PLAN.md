---
phase: 03-ui-and-observability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/cli/client.go
  - internal/cli/format.go
autonomous: true
requirements:
  - DISP-04
  - DISP-06

must_haves:
  truths:
    - "CLI `list` shows gpg_sign requests with file count summary in the SUMMARY column"
    - "CLI `show` displays gpg_sign commit context in git-log style format"
    - "CLI `history` shows gpg_sign entries with commit subject summary"
    - "Existing get_secret and search list/show/history behavior is unchanged"
  artifacts:
    - path: "internal/cli/client.go"
      provides: "GPGSignInfo struct and field on PendingRequest"
      contains: "GPGSignInfo"
    - path: "internal/cli/format.go"
      provides: "gpg_sign branches in FormatRequests, formatRequest, FormatHistory, and secretSummary"
      contains: "gpg_sign"
  key_links:
    - from: "internal/cli/format.go"
      to: "internal/cli/client.go"
      via: "req.GPGSignInfo field access"
      pattern: "req\\.GPGSignInfo"
    - from: "internal/cli/client.go"
      to: "internal/approval/gpgsign.go"
      via: "JSON deserialization of gpg_sign_info from API response"
      pattern: "gpg_sign_info"
---

<objective>
Add gpg_sign display support to CLI list, show, and history commands.

Purpose: Users running `secrets-dispatcher list` see gpg_sign requests with a file count summary. Running `secrets-dispatcher show <id>` on a gpg_sign request displays commit context in git-log style format (commit subject, author, repo, key ID, changed files, with committer and parent hash as secondary).

Output: Updated client.go with GPGSignInfo struct/field, updated format.go with gpg_sign branches in all formatters.
</objective>

<execution_context>
@/home/nb/.claude-personal/get-shit-done/workflows/execute-plan.md
@/home/nb/.claude-personal/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/cli/client.go
@internal/cli/format.go
@internal/approval/gpgsign.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GPGSignInfo struct and field to cli.PendingRequest</name>
  <files>internal/cli/client.go</files>
  <action>
  Add a `GPGSignInfo` struct to the `cli` package (intentional duplication — the CLI package deliberately does not import internal/approval or internal/api):

  ```go
  type GPGSignInfo struct {
      RepoName     string   `json:"repo_name"`
      CommitMsg    string   `json:"commit_msg"`
      Author       string   `json:"author"`
      Committer    string   `json:"committer"`
      KeyID        string   `json:"key_id"`
      Fingerprint  string   `json:"fingerprint,omitempty"`
      ChangedFiles []string `json:"changed_files"`
      ParentHash   string   `json:"parent_hash,omitempty"`
  }
  ```

  Add field to `PendingRequest`:
  ```go
  GPGSignInfo *GPGSignInfo `json:"gpg_sign_info,omitempty"`
  ```

  Place it after the existing `SearchAttributes` field.
  </action>
  <verify>
    <automated>cd /home/nb/src/secrets-dispatcher && go build ./internal/cli/...</automated>
  </verify>
  <done>cli.PendingRequest has GPGSignInfo pointer field that deserializes from API JSON response for gpg_sign requests.</done>
</task>

<task type="auto">
  <name>Task 2: Add gpg_sign branches to CLI formatters</name>
  <files>internal/cli/format.go</files>
  <action>
  1. **Rename column header** — in `FormatRequests`, rename the "SECRET" column to "SUMMARY" (both header line and separator line). Same in `FormatHistory`.

  2. **Update `secretSummary` to handle gpg_sign** — rename function to `requestSummary` (update all call sites in format.go). Add gpg_sign branch at the top:
     ```go
     func requestSummary(req PendingRequest) string {
         if req.GPGSignInfo != nil {
             n := len(req.GPGSignInfo.ChangedFiles)
             if n == 1 {
                 return "1 file"
             }
             return fmt.Sprintf("%d files", n)
         }
         // ... existing get_secret / search logic unchanged
     }
     ```

  3. **Add git-log style gpg_sign branch to `formatRequest`** (the `show` command output). After the existing Type line, add a conditional block:
     ```go
     if req.GPGSignInfo != nil {
         info := req.GPGSignInfo
         fmt.Fprintf(f.w, "Repo:    %s\n", info.RepoName)
         fmt.Fprintf(f.w, "Author:  %s\n", info.Author)
         fmt.Fprintf(f.w, "Key:     %s\n", info.KeyID)
         fmt.Fprintf(f.w, "\n    %s\n", commitSubject(info.CommitMsg))
         if body := commitBody(info.CommitMsg); body != "" {
             // Indent each line of the body with 4 spaces
             for _, line := range strings.Split(body, "\n") {
                 fmt.Fprintf(f.w, "    %s\n", line)
             }
         }
         fmt.Fprintln(f.w)
         fmt.Fprintf(f.w, "Changed files (%d):\n", len(info.ChangedFiles))
         for _, file := range info.ChangedFiles {
             fmt.Fprintf(f.w, "  %s\n", file)
         }
         if info.Committer != "" && info.Committer != info.Author {
             fmt.Fprintf(f.w, "\nCommitter: %s\n", info.Committer)
         }
         if info.ParentHash != "" {
             fmt.Fprintf(f.w, "Parent:    %s\n", info.ParentHash)
         }
     }
     ```
     Skip the existing Items/SearchAttributes display when `GPGSignInfo != nil` (use `else if` or early return for the gpg_sign branch).

  4. **Add helper functions** `commitSubject` and `commitBody`:
     ```go
     func commitSubject(msg string) string {
         if i := strings.IndexByte(msg, '\n'); i >= 0 {
             return msg[:i]
         }
         return msg
     }

     func commitBody(msg string) string {
         i := strings.IndexByte(msg, '\n')
         if i < 0 {
             return ""
         }
         body := strings.TrimLeft(msg[i:], "\n")
         return strings.TrimRight(body, "\n")
     }
     ```

  5. **Ensure all existing tests still pass** — the column rename from SECRET to SUMMARY doesn't affect existing tests (no test assertions on column headers currently exist in client_test.go).
  </action>
  <verify>
    <automated>cd /home/nb/src/secrets-dispatcher && go test -race -v ./internal/cli/...</automated>
  </verify>
  <done>
  - `list` shows "SUMMARY" column with file count ("N files") for gpg_sign and secret label for get_secret
  - `show` on gpg_sign renders git-log style: repo, author, key ID, indented commit message, changed files, secondary metadata
  - `history` shows "SUMMARY" column with appropriate summary per type
  - All existing get_secret/search formatting behavior unchanged
  </done>
</task>

</tasks>

<verification>
```bash
cd /home/nb/src/secrets-dispatcher && go test -race -v ./internal/cli/...
cd /home/nb/src/secrets-dispatcher && go build ./...
```
All tests pass. Build succeeds. Verify `go vet ./internal/cli/...` has no issues.
</verification>

<success_criteria>
- `go test -race ./internal/cli/...` passes
- `go build ./...` succeeds
- GPGSignInfo struct in cli package matches JSON field names from approval.GPGSignInfo
- list/history column header reads "SUMMARY" not "SECRET"
- gpg_sign summary shows file count; show command renders git-log style output
</success_criteria>

<output>
After completion, create `.planning/phases/03-ui-and-observability/03-02-SUMMARY.md`
</output>
