---
phase: 02-core-signing-flow
plan: "02"
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/gpgsign/commit.go
  - internal/gpgsign/commit_test.go
  - internal/gpgsign/gpg.go
  - internal/gpgsign/gpg_test.go
autonomous: true
requirements:
  - SIGN-02

must_haves:
  truths:
    - "ParseCommitObject extracts author, committer, message, and parent hash from a raw git commit object"
    - "FindRealGPG locates the real gpg binary in PATH, skipping the secrets-dispatcher binary itself"
    - "extractKeyID parses the key ID from git's gpg invocation args (-bsau <keyID>)"
  artifacts:
    - path: "internal/gpgsign/commit.go"
      provides: "ParseCommitObject function"
      exports: ["ParseCommitObject"]
    - path: "internal/gpgsign/gpg.go"
      provides: "FindRealGPG and extractKeyID functions"
      exports: ["FindRealGPG"]
    - path: "internal/gpgsign/commit_test.go"
      provides: "Tests for ParseCommitObject"
      contains: "TestParseCommitObject"
    - path: "internal/gpgsign/gpg_test.go"
      provides: "Tests for FindRealGPG and extractKeyID"
      contains: "TestFindRealGPG"
  key_links:
    - from: "internal/gpgsign/commit.go"
      to: "internal/approval/gpgsign.go"
      via: "ParseCommitObject output populates GPGSignInfo fields"
      pattern: "ParseCommitObject"
---

<objective>
Implement and test the thin client's pure functions: ParseCommitObject (parses raw git commit objects), FindRealGPG (finds real gpg binary in PATH), and extractKeyID (parses key ID from git's gpg args).

Purpose: These pure functions have well-defined inputs and outputs, making them ideal TDD candidates. They are the foundation of the thin client â€” Run() (Plan 04) calls all three.

Output: Tested, working internal/gpgsign/ package with commit parsing, GPG discovery, and arg parsing.
</objective>

<execution_context>
@/home/nb/.claude-personal/get-shit-done/workflows/execute-plan.md
@/home/nb/.claude-personal/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-signing-flow/02-RESEARCH.md

@internal/approval/gpgsign.go
</context>

<feature>
  <name>Thin client pure functions: ParseCommitObject, FindRealGPG, extractKeyID</name>
  <files>
    internal/gpgsign/commit.go
    internal/gpgsign/commit_test.go
    internal/gpgsign/gpg.go
    internal/gpgsign/gpg_test.go
  </files>
  <behavior>
**ParseCommitObject(data []byte) (author, committer, message, parentHash string)**

Parses the raw git commit object format. Headers are `key value\n` pairs until a blank line, then the body is the commit message.

Test cases:
- Standard commit with tree, author, committer, blank line, message -> extracts all fields, parentHash empty
- Commit with parent line -> parentHash populated
- Merge commit with multiple parent lines -> first parent hash used
- Empty message -> message is empty string
- Multi-line message -> full message including newlines preserved
- Commit message with trailing newline stripped (git adds trailing newline)

Reference format (from RESEARCH.md):
```
tree 8754a964a0ce1b6c5f7a88202174955bdcd58a98
parent abc123def456
author Alice Example <alice@example.com> 1771936651 +0200
committer Alice Example <alice@example.com> 1771936651 +0200

feat: add files
```

**FindRealGPG() (string, error)**

Scans PATH directories for a `gpg` binary, skipping any candidate that is the same file as os.Executable() (using os.SameFile for inode comparison).

Test cases:
- gpg exists in PATH and is not self -> returns path
- Only self in PATH -> returns error "gpg not found in PATH"
- gpg not found at all -> returns error
- Multiple gpg binaries, first is self, second is real -> returns second

Note: Tests should use temp directories and fake binaries to avoid system gpg dependency.

**extractKeyID(args []string) string**

Parses git's gpg invocation args: `--status-fd=2 -bsau <keyID>`. The key ID follows the `-u` flag (which may be combined as `-bsau`).

Test cases:
- `["--status-fd=2", "-bsau", "846FFFEFC1039264"]` -> `"846FFFEFC1039264"`
- `["--status-fd=2", "-bsa", "-u", "846FFFEFC1039264"]` -> `"846FFFEFC1039264"`
- `["-u", "ABCD1234"]` -> `"ABCD1234"`
- `["--status-fd=2", "-bsa"]` -> `""` (no key ID)
- Empty args -> `""`
  </behavior>
  <implementation>
**commit.go:**
Use `bufio.Scanner` to read lines. Track header vs body state with a boolean flag. Match `author `, `committer `, `parent ` prefixes. After blank line, collect remaining lines as message body. Return four strings.

**gpg.go:**
- `FindRealGPG()`: Call `os.Executable()` + `os.Stat()` to get self file info. Split `os.Getenv("PATH")` with `filepath.SplitList`. For each dir, check `filepath.Join(dir, "gpg")` with `os.Stat`. Skip if `os.SameFile` matches self. Return first non-self match.
- `extractKeyID()`: Iterate args. If arg ends with "u" (handles `-bsau` combined flags), the next arg is the key ID. If arg is `-u`, the next arg is the key ID. Return the key ID or empty string.
  </implementation>
</feature>

<verification>
```bash
cd /home/nb/src/secrets-dispatcher && go test ./internal/gpgsign/... -v -timeout 30s
```
All tests pass. `go vet ./internal/gpgsign/...` clean.
</verification>

<success_criteria>
1. ParseCommitObject correctly extracts all fields from standard, single-parent, and merge commits
2. FindRealGPG finds real gpg, skips self, handles missing gpg
3. extractKeyID parses key ID from all observed git gpg arg patterns
4. All test cases pass
5. `go build ./...` succeeds (package compiles as part of the module)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-signing-flow/02-02-SUMMARY.md`
</output>
